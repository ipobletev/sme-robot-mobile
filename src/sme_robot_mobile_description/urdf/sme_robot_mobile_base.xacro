<?xml version="1.0"?>
<robot xmlns:xacro="http://www.ros.org/wiki/xacro">

  <!-- 
    MACRO: MOBILE BASE
    This macro defines the chassis and the 4 wheels.
    Arguments:
      - name: Prefix for the links/joints to avoid naming conflicts
  -->
  <xacro:macro name="mobile_base" params="name">

    <!-- 
      BASE FOOTPRINT
      This is a virtual link that sits on the ground (z=0). 
      It's useful for navigation algorithms to know where the "floor" is relative to the robot.
    -->
    <link name="${name}_footprint"/>

    <joint name="${name}_footprint_joint" type="fixed">
      <parent link="${name}_footprint"/>
      <child link="${name}_chassis"/>
      <origin xyz="0 0 0.08" rpy="0 0 0"/> <!-- Raise chassis 8cm off ground (wheel diameter) -->
    </joint>

    <!-- 
      CHASSIS LINK (Virtual - for collision and inertia)
      The main body of the robot - invisible, used for physics.
    -->
    <link name="${name}_chassis">
      <collision>
        <geometry>
          <box size="0.26 0.245 0.12"/>
        </geometry>
        <material name="black">
          <color rgba="0.1 0.1 0.1 0.1"/>
        </material>
      </collision>
      <inertial>
        <mass value="15.0"/> <!-- Heavy base for stability -->
        <inertia ixx="0.1" ixy="0" ixz="0" iyy="0.1" iyz="0" izz="0.1"/>
      </inertial>
    </link>

    <!-- 
      BOTTOM PLATE
      Lower acrylic plate (3mm thickness)
    -->
    <link name="${name}_base_link">
      <visual>
        <geometry>
          <box size="0.26 0.245 0.003"/> <!-- 26cm x 24.5cm x 3mm -->
        </geometry>
        <material name="black">
          <color rgba="0.1 0.1 0.1 1"/>
        </material>
      </visual>
    </link>

    <joint name="${name}_base_link_joint" type="fixed">
      <parent link="${name}_chassis"/>
      <child link="${name}_base_link"/>
      <origin xyz="0 0 0" rpy="0 0 0"/> <!-- Bottom of chassis (12cm/2 = 6cm down) -->
    </joint>

    <!-- 
      TOP PLATE
      Upper acrylic plate (3mm thickness)
    -->
    <link name="${name}_top_plate">
      <visual>
        <geometry>
          <box size="0.26 0.245 0.003"/> <!-- 26cm x 24.5cm x 3mm -->
        </geometry>
        <material name="black">
          <color rgba="0.1 0.1 0.1 1"/>
        </material>
      </visual>
    </link>

    <joint name="${name}_top_plate_joint" type="fixed">
      <parent link="${name}_base_link"/>
      <child link="${name}_top_plate"/>
      <origin xyz="0 0 0.04" rpy="0 0 0"/> <!-- Top of chassis (12cm/2 = 6cm up) -->
    </joint>

    <!-- 
      WHEEL MACRO
      Helper to create 4 identical wheels.
    -->
    <xacro:macro name="wheel" params="prefix x_pos y_pos z_pos">
      <link name="${name}_${prefix}_wheel">
        <visual>
          <geometry>
            <cylinder radius="0.04" length="0.037"/> <!-- 80mm diameter, 37mm width -->
          </geometry>
          <material name="black">
            <color rgba="0 0 0 1"/>
          </material>
        </visual>
        <collision>
          <geometry>
            <cylinder radius="0.04" length="0.037"/>
          </geometry>
        </collision>
        <inertial>
          <mass value="1.0"/>
          <inertia ixx="0.01" ixy="0" ixz="0" iyy="0.01" iyz="0" izz="0.01"/>
        </inertial>
      </link>

      <joint name="${name}_${prefix}_wheel_joint" type="continuous">
        <parent link="${name}_chassis"/>
        <child link="${name}_${prefix}_wheel"/>
        <!-- Rotate cylinder to be upright for a wheel -->
        <origin xyz="${x_pos} ${y_pos} ${z_pos}" rpy="-1.5707 0 0"/> 
        <axis xyz="0 0 1"/> <!-- Rotate around the cylinder's Z axis (which is robot's Y) -->
      </joint>
    </xacro:macro>

    <!-- Instantiate 4 wheels at corners of 26cm x 24.5cm plate -->
    <!-- x_pos = 0.26/2 (plate width/2) - 0.04 wheel radius = 0.09 -->
    <!-- y_pos = 0.245/2 (plate height/2) + 0.0374/2 wheel width = 0.1412 -->
    <!-- z_pos = -0.04 wheel radius to base link (bottom plate) -->
    <xacro:wheel prefix="front_left"  x_pos="0.09"  y_pos="0.1412" z_pos="-0.04"/> <!-- robot_base_front_left -->
    <xacro:wheel prefix="front_right" x_pos="0.09"  y_pos="-0.1412" z_pos="-0.04"/> <!-- robot_base_front_right -->
    <xacro:wheel prefix="rear_left"   x_pos="-0.09" y_pos="0.1412" z_pos="-0.04"/> <!-- robot_base_rear_left -->
    <xacro:wheel prefix="rear_right"  x_pos="-0.09" y_pos="-0.1412" z_pos="-0.04"/> <!-- robot_base_rear_right -->

  </xacro:macro>
</robot>
